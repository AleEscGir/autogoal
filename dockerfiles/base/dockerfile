# =====================
# Debian base image
# ---------------------

FROM docker.uclv.cu/bitnami/minideb:latest


# =====================
# User stuff
# ---------------------

RUN apt-get update \
 && apt-get install -y \
    curl \
    locales \
    nano \
    ssh \
    sudo \
    bash \
    python3-pip

RUN pip3 install -U pip

RUN rm -rf /var/lib/apt/lists/*

# https://wiki.debian.org/Locale#Manually
RUN sed -i "s/# en_US.UTF-8/en_US.UTF-8/" /etc/locale.gen \
  && locale-gen
ENV LANG=en_US.UTF-8

RUN chsh -s /bin/bash
ENV SHELL=/bin/bash

RUN adduser --gecos '' --disabled-password coder && \
  echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/nopasswd

# ==========================================
# Project-specific installation instruction
# ------------------------------------------

COPY bash.bashrc /etc
RUN chmod +x /etc/bash.bashrc

ENV BUILD_ENVIRONMENT="development"
ENV XDG_CACHE_HOME="/opt/dev/cache"

WORKDIR /home/coder/autogoal

COPY ./ /home/coder/autogoal/

RUN rm -r /home/coder/autogoal/autogoal/contrib/gensim \
          /home/coder/autogoal/autogoal/contrib/keras \
          /home/coder/autogoal/autogoal/contrib/nltk \
          /home/coder/autogoal/autogoal/contrib/sklearn \
          /home/coder/autogoal/autogoal/contrib/spacy \
          /home/coder/autogoal/autogoal/contrib/streamlit \
          /home/coder/autogoal/autogoal/contrib/telegram \
          /home/coder/autogoal/autogoal/contrib/transformers \
          /home/coder/autogoal/autogoal/contrib/wikipedia

COPY pyproject.toml poetry.lock makefile /home/coder/autogoal/

RUN make env

RUN poetry install

CMD ["/bin/bash"]